<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cart — Interactive</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, "Poppins", sans-serif}
    body{background:#f6f7fb;color:#222;padding:18px;direction:rtl}
    .wrap{max-width:820px;margin:28px auto;background:#fff;border-radius:10px;padding:20px;box-shadow:0 6px 22px rgba(16,24,40,.08)}
    h1{font-size:20px;margin-bottom:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:right}
    .controls{display:flex;gap:10px;justify-content:center;margin-top:16px}
    .btn{padding:8px 14px;border-radius:8px;border:none;cursor:pointer}
    .btn-red{background:#ef4444;color:#fff}
    .btn-green{background:#16a34a;color:#fff}
    .info{max-width:760px;margin:14px auto;padding:10px 12px;border-radius:8px;display:none}
    .info.ok{background:#d1fae5;color:#065f46}
    .info.warn{background:#fff7cd;color:#7c5a00}
    .small{font-size:13px;color:#666;margin-top:8px;text-align:center}
    .dev{margin-top:14px;background:#f3f4f6;padding:10px;border-radius:8px}
    textarea{width:100%;height:120px;padding:8px;border-radius:6px;border:1px solid #ddd;font-family:monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>عربة التسوق — عرض تفاعلي</h1>

    <table id="cart-table">
      <tr><th>المنتج</th><th>السعر</th></tr>
    </table>

    <p id="total" style="text-align:left;font-weight:600;margin-top:8px"></p>

    <div class="controls">
      <button class="btn btn-red" id="clearBtn">مسح العربة محلياً</button>
      <button class="btn btn-green" id="checkoutBtn">Checkout (Demo)</button>
    </div>

    <div id="infoBox" class="info"></div>

    <div class="dev">
      <h4>أدوات تفاعل سريعة</h4>
      <p class="small">إذا التقطت الطلب في Burp وعدلت الحقول، استخدم إما: (أ) أرجع رد مخصص في Burp يحوي JSON مناسب، أو (ب) انسخ JSON من Burp ولصقه هنا ثم اضغط <strong>Apply pasted server response</strong>.</p>
      <textarea id="pastedResp" placeholder='الصق هنا JSON معدّل (مثال: {"items":[{"name":"X","price":1.5}],"total":1.5})'></textarea>
      <div style="margin-top:8px"><button class="btn" id="applyPasted">Apply pasted server response</button></div>
    </div>

    <p class="small">ملاحظة: إذا وصل المتصفح رد JSON من Burp (أو من endpoint) عند الضغط على Add at Shop، سيخزن تلقائياً في <code>localStorage.server_cart</code> ويُستخدم هنا عند التحميل.</p>
  </div>

  <script>
    const CART_KEY = 'cart';
    const SERVER_CART_KEY = 'server_cart';

    function showInfo(msg, ok=true){
      const box = document.getElementById('infoBox');
      box.style.display = 'block';
      box.className = 'info ' + (ok ? 'ok' : 'warn');
      box.textContent = msg;
      setTimeout(()=>{ box.style.display = 'none'; }, 6000);
    }

    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function loadCartLocal(){ return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); }
    function saveCartLocal(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); }
    function loadServerCart(){ try{ return JSON.parse(localStorage.getItem(SERVER_CART_KEY) || 'null'); }catch(e){ return null; } }
    function clearServerCart(){ localStorage.removeItem(SERVER_CART_KEY); }

    function renderFromItems(items){
      const table = document.getElementById('cart-table');
      table.querySelectorAll('tr.item-row').forEach(r=>r.remove());
      let total = 0;
      (items || []).forEach(it=>{
        const tr = document.createElement('tr');
        tr.className = 'item-row';
        tr.innerHTML = `<td>${escapeHtml(it.name)}</td><td>$${Number(it.price).toFixed(2)}</td>`;
        table.appendChild(tr);
        total += Number(it.price || 0);
      });
      document.getElementById('total').textContent = `Total: $${total.toFixed(2)}`;
    }

    // عند التحميل: إذا وجد server_cart استخدمه، وإلا استخدم الـ local cart
    function init(){
      const serverCart = loadServerCart();
      if(serverCart && (serverCart.items || serverCart.length)){
        // serverCart قد يأتي في أشكال مختلفة — ندعم أكثر من شكل:
        let items = null;
        if(Array.isArray(serverCart)) items = serverCart;
        else if(Array.isArray(serverCart.items)) items = serverCart.items;
        else if(Array.isArray(serverCart.cart)) items = serverCart.cart;
        else items = []; // fallback

        renderFromItems(items);
        // بعد العرض نمسح الـ server_cart حتى لا يظهر مجدداً بالتحميل التالي
        clearServerCart();
        showInfo('عرض نتائج الـ server (معدّلة عبر Burp أو endpoint).', true);
      } else {
        const local = loadCartLocal();
        renderFromItems(local);
        showInfo('عرض العربة المحلية (client-side).', true);
      }
    }

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      localStorage.removeItem(CART_KEY);
      showInfo('تم مسح العربة محلياً.', true);
      renderFromItems([]);
    });

    // زر يطبّق JSON ملصوق يدوياً (من Burp بعد تحريره) ليظهر فوراً
    document.getElementById('applyPasted').addEventListener('click', ()=>{
      const txt = document.getElementById('pastedResp').value.trim();
      if(!txt){ showInfo('الصق JSON ثم اضغط Apply.', false); return; }
      try {
        const j = JSON.parse(txt);
        // نخزن في server_cart ونعيد التحميل لعرضه بنفس المنطق
        localStorage.setItem(SERVER_CART_KEY, JSON.stringify(j));
        showInfo('تم تطبيق الرد المُلصق. إعادة تحميل الصفحة لعرض النتائج...', true);
        setTimeout(()=>location.reload(), 800);
      } catch (e) {
        showInfo('JSON غير صالح — افحص التنسيق.', false);
      }
    });

    init();
  </script>
</body>
</html>
