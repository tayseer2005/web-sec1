<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cart (Burp interactive)</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:Poppins,Inter,sans-serif}
    body{background:#f6f7fb;color:#222;padding:18px;direction:rtl}
    .wrap{max-width:820px;margin:28px auto;background:#fff;border-radius:10px;padding:20px;box-shadow:0 6px 22px rgba(16,24,40,.08)}
    h1{font-size:20px;margin-bottom:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:right}
    .controls{display:flex;gap:10px;justify-content:center;margin-top:16px}
    .btn{padding:8px 14px;border-radius:8px;border:none;cursor:pointer}
    .btn-red{background:#ef4444;color:#fff}
    .btn-green{background:#16a34a;color:#fff}
    .info{max-width:760px;margin:14px auto;padding:10px 12px;border-radius:8px;display:none}
    .info.ok{background:#d1fae5;color:#065f46}
    .info.warn{background:#fff7cd;color:#7c5a00}
    .small{font-size:13px;color:#666;margin-top:8px;text-align:center}
    .dev{margin-top:14px;background:#f3f4f6;padding:10px;border-radius:8px}
    textarea{width:100%;height:120px;padding:8px;border-radius:6px;border:1px solid #ddd;font-family:monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>عربة التسوق — عرض التعديلات من Burp</h1>

    <table id="cart-table">
      <tr><th>المنتج</th><th>السعر</th></tr>
    </table>

    <p id="total" style="text-align:left;font-weight:600;margin-top:8px"></p>

    <div class="controls">
      <button class="btn btn-red" id="clearBtn">مسح العربة محلياً</button>
      <button class="btn btn-green" id="checkoutBtn">Checkout (Demo)</button>
    </div>

    <div id="infoBox" class="info"></div>

    <div class="dev">
      <h4>أدوات تفاعل سريعة</h4>
      <p class="small">لو استلم المتصفح رد JSON من Burp سيخزن تلقائياً في <code>localStorage.server_cart</code> وسيعرض هنا.</p>
      <p class="small">إذا تريد وضع JSON مُعدل يدوياً للصق والاختبار، استخدم الـ Console أو localStorage.setItem('server_cart', JSON.stringify({...})); ثم reload.</p>
      <textarea id="pastedResp" placeholder='(اختياري) الصق JSON هنا لعرضه فوراً'></textarea>
      <div style="margin-top:8px"><button class="btn" id="applyPasted">Apply pasted server response</button></div>
    </div>
  </div>

<script>
const CART_KEY='cart';
const SERVER_CART_KEY='server_cart';

function showInfo(msg,ok=true){
  const box=document.getElementById('infoBox');
  box.style.display='block';
  box.className='info '+(ok?'ok':'warn');
  box.textContent=msg;
  setTimeout(()=>{box.style.display='none';},6000);
}

function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function loadLocalCart(){ return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); }
function loadServerCart(){ try{ return JSON.parse(localStorage.getItem(SERVER_CART_KEY) || 'null'); }catch(e){ return null; } }
function clearServerCart(){ localStorage.removeItem(SERVER_CART_KEY); }

function render(items){
  const table=document.getElementById('cart-table');
  table.querySelectorAll('tr.item-row').forEach(r=>r.remove());
  let total=0;
  (items||[]).forEach(it=>{
    const tr=document.createElement('tr');
    tr.className='item-row';
    tr.innerHTML=`<td>${escapeHtml(it.name)}</td><td>$${Number(it.price).toFixed(2)}</td>`;
    table.appendChild(tr);
    total+=Number(it.price||0);
  });
  document.getElementById('total').textContent=`Total: $${total.toFixed(2)}`;
}

function init(){
  const server = loadServerCart();
  if(server && (server.items || Array.isArray(server) || server.cart)){
    // احضر صيغة العناصر من أشكال مختلفة
    let items = null;
    if(Array.isArray(server)) items = server;
    else if(Array.isArray(server.items)) items = server.items;
    else if(Array.isArray(server.cart)) items = server.cart;
    else items = [];
    render(items);
    clearServerCart(); // نمسح حتى لا يعاد العرض في reload المقبل
    showInfo('عرض القيم التي أرسلتها/عدّلتها عبر Burp (server_cart).', true);
    return;
  }

  // FALLBACK: عرض العربة المحلية
  const local = loadLocalCart();
  render(local);
  showInfo('عرض العربة المحلية (لم يصل تعديل من Burp).', true);
}

document.getElementById('clearBtn').addEventListener('click', ()=>{
  localStorage.removeItem(CART_KEY);
  showInfo('تم مسح العربة محلياً.', true);
  render([]);
});

document.getElementById('applyPasted').addEventListener('click', ()=>{
  const txt=document.getElementById('pastedResp').value.trim();
  if(!txt){ showInfo('الصق JSON ثم اضغط Apply.', false); return; }
  try {
    const j=JSON.parse(txt);
    localStorage.setItem(SERVER_CART_KEY, JSON.stringify(j));
    showInfo('تم تطبيق الرد المُلصق. إعادة تحميل لعرض النتائج...', true);
    setTimeout(()=>location.reload(),700);
  } catch(e){
    showInfo('JSON غير صالح — افحص التنسيق.', false);
  }
});

init();
</script>
</body>
</html>
